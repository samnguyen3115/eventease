{% extends "base.html" %} {% block content %}
<!-- Modal for verify Task with Image -->
<div id="verifyTaskModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="verifyTaskModalLabel" aria-hidden="true">
    <div id="loadingOverlay" style="
    display: none;
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(255, 255, 255, 0.8);
    z-index: 9999;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 2rem;
    color: #333;
">
    <div>
        <div class="spinner-border" role="status" style="width: 4rem; height: 4rem; margin-left: 130px;">
        </div>
        <div style="margin-top: 10px;">Processing your image...</div>
    </div>
</div>
    <div class="modal-dialog" role="document" > 
        <div class="modal-content" >
            <div class="modal-header">
                <h5 class="modal-title" id="verifyTaskModalLabel">Complete Task</h5>
            </div>
            <div class="modal-body">
                <form id="verifyTaskForm"  enctype="multipart/form-data">
                    <input type="hidden" id="taskId" name="taskId">
                    <div class="form-group">
                        <label for="taskImage">Upload an Image of the Item</label>
                        <input type="file" class="form-control"  id="taskImage" name="file" accept="image/*" required>
                    </div>
                </br>
                <div class="modal-footer d-flex justify-content-between">
                    <button type="submit" class=" submit-btn">Submit</button>
                    <button type="button" class="btn btn-secondary" onclick="bypassItem()">Bypass</button>
                    <button type="button" class=" close-btn" onclick="closeModal()" data-dismiss="modal">Close</button>
                </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Verify Completed Task -->
<div id="verifyCompletedTaskModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="verifyCompletedTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="verifyCompletedTaskModalLabel">Approve Task Completion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="taskImageContainer" style="text-align: center;">
                    <img id="taskImagePreview" src="" alt="Task Image" style="max-width: 100%; max-height: 300px; border: 1px solid #ccc; padding: 5px;">
                </div>
                <p id="taskDescription" style="margin-top: 10px; text-align: center; font-weight: bold;"></p>
            </div>
            <div class="form-group">
                <label for="TaskNote">Note</label>
                <input type="text" class="form-control" id="TaskNote"  placeholder="Enter task Note">
            </div>
            <div class="modal-footer d-flex justify-content-between">
                <button type="button" class="submit-btn" onclick="verifyTask(true)">Approved</button>
                <button type="button" class="close-btn" onclick="verifyTask(false)">Disapproved</button>
            </div>
        </div>
    </div>
</div>
<!-- Change Event  Modal -->
<div id="editEventModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="editEventModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editEventModalLabel">Edit Event </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editEventForm">
                    <div class = "form-group">
                        <label for="eventName" style="color:rgb(0, 0, 0)">Event Name</label>
                        <input type="text" class="form-control" id="eventName" value="{{ event.name }}" placeholder="Enter event name">
                    </div>
                    <div class = "form-group">
                        <label for="eventDate" style="color:rgb(0, 0, 0)">Event Date</label>
                        <input type="date" class="form-control" id="eventDate" placeholder="Enter event date">
                    </div>
                    <div class="form-group">
                        <label for="newOwnerSelect" style="color:rgb(0, 0, 0)">Select New Owner</label>
                        <select class="form-control" id="newOwnerSelect">
                            {% for participant in event.participants %}
                                <option value="{{ participant.id }}">{{ participant.username }}</option>
                            {% endfor %}
                        </select>
                    </div>

                </form>
            </div>
            <div class="modal-footer d-flex justify-content-between">
                <button type="button" class="submit-btn" onclick="submitEditEvent()">Change Owner</button>
                <button type="button" class="close-btn" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<!-- AddTaskModal -->
<div id="addTaskModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="addTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content" >
            <div class="modal-header">
                <h5 class="modal-title" id="addTaskModalLabel">Add New Task</h5>
            </div>
            <div class="modal-body">
                <form id="addTaskForm">
                    <div class="form-group">
                        <label for="newTaskDescription">Description</label>
                        <input type="text" class="form-control" id="newTaskDescription"  placeholder="Enter task description">
                    </div>
                    <div class="form-group">
                        <label for="newTaskNote">Note</label>
                        <input type="text" class="form-control" id="newTaskNote"  placeholder="Enter task Note">
                    </div>
                    <div class="form-group">
                        <label for="newTaskItem">Item</label>
                        <input type="text" class="form-control" id="newTaskItem"  placeholder="Enter task item">
                    </div>
                    <div class="form-group">
                        <label for="newTaskPriority">Priority</label>
                        <select class="form-control" id="newTaskPriority">
                            <option value="1" style="color: rgb(0, 0, 0);">Important</option>
                            <option value="2" style="color: rgb(0, 0, 0);">Necessary</option>
                            <option value="3" style="color: rgb(0, 0, 0);">Normal</option>
                        </select>
                    </div>
                    <!-- New Due Date Field -->
                    <div class="form-group">
                        <label for="newTaskDueDate">Due Date</label>
                        <input type="date" class="form-control" id="newTaskDueDate">
                    </div>
                </form>
            </div>
            <div class="modal-footer d-flex justify-content-between">
                <button type="button" class=" submit-btn" onclick="submitAddTask()">Add Task</button>
                <button type="button" class=" close-btn" onclick="closeModal()" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<!-- Assign User To Task Modal -->
<div id="assignUserModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="assignUserModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content" >
            <div class="modal-header">
                <h5 class="modal-title" id="assignUserModalLabel" >Assign User to Task</h5>
            </div>
            <div class="modal-body">
                <form id="assignUserForm">
                    <div class="form-group">
                        <label style="color:rgb(0, 0, 0)">Select User(s)</label>
                        <div id="assignUserCheckboxes" class="fluent-checkbox-group">
                            {% for user in users %}
                                <div class="fluent-checkbox-wrapper">
                                    <input type="checkbox" 
                                           id="user-{{ user.id }}" 
                                           value="{{ user.id }}" 
                                           class="fluent-checkbox">
                                    <label for="user-{{ user.id }}" class="fluent-checkbox-label">
                                        {{ user.username }}
                                    </label>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    <input type="hidden" id="assignTaskId"> <!-- Hidden input to store the task ID -->
                </form>
            </div>
            <div class="modal-footer d-flex justify-content-between">
                <button type="button" class=" submit-btn" onclick="submitAssignUser()">Assign</button>
                <button type="button" class=" close-btn" onclick="closeModal()" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


    <!-- Assign User to Event Modal -->
<div id="assignUserToEventModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="assignUserToEventModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="assignUserToEventModalLabel">Assign User to Event</h5>
            </div>
            <div class="modal-body">
                <form id="assignUserToEventForm">
                    <div class="form-group">
                        <label style="color:rgb(0, 0, 0)">Select Friend(s)</label>
                        <div id="assignFriendCheckboxes" class="fluent-checkbox-group">
                            {% for friend in friends %}
                                <div class="fluent-checkbox-wrapper">
                                    <input type="checkbox" 
                                           id="friend-{{ friend.id }}" 
                                           value="{{ friend.id }}" 
                                           class="fluent-checkbox"
                                           {% if friend in event.participants %}checked{% endif %}>
                                    <label for="friend-{{ friend.id }}" class="fluent-checkbox-label">
                                        {{ friend.username }}
                                    </label>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer d-flex justify-content-between">
                <button type="button" class="submit-btn" onclick="submitAssignFriendsToEvent()">Assign</button>
                <button type="button" class="close-btn" onclick="closeModal()" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

  <!-- Edit Task Modal -->
  <div id="editTaskModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="editTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content" >
            <div class="modal-header">
                <h5 class="modal-title" id="editTaskModalLabel">Edit Task</h5>
            </div>
            <div class="modal-body">
                <form id="editTaskForm">
                    <input type="hidden" id="editTaskId">
                    <div class="form-group">
                        <label for="editTaskDescription">Description</label>
                        <input type="text" class="form-control" id="editTaskDescription" placeholder="Enter task description">
                    </div>
                    <div class="form-group">
                        <label for="editTaskNote">Note</label>
                        <input type="text" class="form-control" id="editTaskNote" placeholder="Enter task Note">
                    </div>
                    <div class="form-group">
                        <label for="editTaskItem">Item</label>
                        <input type="text" class="form-control" id="editTaskItem" placeholder="Enter task description">
                    </div>
                    <div class="form-group">
                        <label for="editTaskPriority">Priority</label>
                        <select class="form-control" style="background-color: #ffffff; color: rgb(0, 0, 0)" id="editTaskPriority">
                            <option value="1" style="color: rgb(0, 0, 0);">Important</option>
                            <option value="2" style="color: rgb(0, 0, 0);">Necessary</option>
                            <option value="3" style="color: rgb(0, 0, 0);">Normal</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editTaskDueDate">Due Date</label>
                        <input type="date" class="form-control" id="editTaskDueDate" >
                    </div>
                </form>
            </div>
            <div class="modal-footer d-flex justify-content-between">
                <button type="button" class=" submit-btn" onclick="submitEditTask()">Save Changes</button>
                <button type="button" class=" close-btn" onclick="closeModal()" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="event-card-2">
    <!-- Progress Bar -->
    <div style="display: flex; align-items: center; justify-content: space-between; width: 100%; height: 60px; padding: 0 15px;">
               <!-- Left Button -->
        <button class="fluent-button" onclick="openAssignUserToEventModal()">
            <img src="{{ url_for('static', filename='img/add_user.png') }}" alt="Add User">
        </button>
    
        <!-- Center Name -->
        <h2 >{{ event.name }}</h2>
    
        <!-- Right Button -->
        <button class="fluent-button" onclick="openAddTaskModal()">
            <img src="{{ url_for('static', filename='img/add_task.png') }}" alt="Add Task">
        </button>
    </div>
    <p ><strong>Date:</strong> {{ event.date.strftime('%Y-%m-%d') }}</p>
    <div class="progress-bar-container">
        <div class="progress-bar">
            <div class="progress-bar-fill" style="width: 0%;"></div>
        </div>
        <div class="strict-mode-toggle" style="margin: 10px;">
            <label for="strictModeToggle" style="font-weight: bold; color: black;">Strict Mode:</label>
            <label class="switch">
                <input type="checkbox" id="strictModeToggle" onchange="toggleStrictMode()" {% if strict_mode %}checked{% else %}unchecked{% endif %}>
                <span class="slider round"></span>
            </label>
        </div>
    </div>
     
    
  
<ul class="tasks-list">
    {% for task in tasks %}
        <li class="task-item">
            <!-- Checkbox and Task Description -->
            <div class="task-details">
                <!-- Task Description -->
                <label class="task-label" style="display: flex; align-items: center;">
                    <input type="checkbox" name="task_ids" value="{{ task.id }}" {% if task.completed %}checked{% endif %} class="custom-checkbox">
                    <span class="task-text" id="task-text-{{ task.id }}" style="{% if task.priority == 1 %} color: rgb(212, 0, 0);{% elif task.priority == 2 %}color:#a37002 ;{% else %}color:black;{% endif %}">
                        {{ task.description }}
                    </span>
                </label>
                <div class = "task-note">
                    {% if task.note and task.note != "None" %}
                        <span class="task-note" style="font-size: 15px; color: #5c5c5b; margin-left: 5px;">Note: {{ task.note }}</span>
                    {% endif %}
                </div>
                <!-- Due Date -->
                <div class="task-due-date">
                    {% if task.due_date and not task.completed %}
                        {% if task.due_date < current_date %}
                            <span class="due-date" style="font-size:13px; color: #fb414af3; margin-left: 5px;">Overdue, You should have done it {{ (current_date- task.due_date).days }} day{{ 's' if (current_date- task.due_date).days > 1 else '' }} ago</span>
                        {% else %}
                            <span class="due-date" style="font-size:13px; margin-left: 5px; color: rgba(107, 104, 104, 0.814);">Due: {{ task.due_date.strftime('%Y-%m-%d') }}</span>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
            <!-- Buttons -->
            <div class="task-buttons">
                <div class="assign-user-container" style="margin: 0;">
                    {% if task.assigned_users|length > 0 %}
                        {% for user in task.assigned_users %}
                            <div class="user-icon-container" >
                                {% if user.profile_picture %}
                                    <img src="{{ url_for('static', filename=user.profile_picture) }}" alt="{{ user.username }}" class="user-icon">
                                {% else %}
                                    <img src="{{ url_for('static', filename='img/user.png') }}" alt="{{ user.username }}" class="user-icon">
                                {% endif %}
                                <span class="user-tooltip">{{ user.username }}</span>
                            </div>
                        {% endfor %}
                    {% else %}
                        <button class="btn task-btn" onclick="openAssignUserModal({{ task.id }})">
                            <img class="img-btn" src="{{ url_for('static', filename='img/add_user.png') }}" alt="Assign User" style="width: 35px; height: 35px;">
                        </button>
                    {% endif %}
                </div>

                <button class="btn task-btn"  onclick="openEditTaskModal({{ task.id }}, '{{ task.description }}','{{task.note}}', {{ task.priority }},'{{ task.due_date.strftime('%Y-%m-%d') if task.due_date else '' }}', '{{ task.item }}')">
                    <img class = "img-btn" src="{{ url_for('static', filename='img/edit_task.png') }}" alt="Edit" style="width: 35px; height: 35px;">
                </button>
                {%if event.user_id == current_user.id and event.strict_mode == true and task.item != "none" and task.completed%}
                <button class="btn task-btn" onclick="openVerifyCompletedTaskModal({{ task.id }},'{{task.note}}', '{{ task.image_link }}', '{{ task.description }}')">
                    <img class="img-btn" src="{{ url_for('static', filename='img/verify.png') }}" alt="Verify Task" style="width: 35px; height: 35px;">
                </button>
                {%endif%}
                <form action="{{ url_for('main.delete_task', task_id=task.id) }}" method="POST" style="display: inline;">
                    <input type="hidden" name="_method" value="DELETE">
                    <button type="submit" class="task-btn " id ="delete-btn" onclick="return confirm('Are you sure you want to delete this task?');">
                        <img class=" img-btn" id ="delete-img" src="{{ url_for('static', filename='img/delete.png') }}" alt="Delete" style="width: 35px; height: 35px;">
                    </button>
                </form>
                
            </div>
            
        </li>
    {% endfor %}
</ul>

    <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
        <form action="{{ url_for('main.delete_event', event_id=event.id) }}" method="POST" class="delete-form">
            <input type="hidden" name="_method" value="DELETE">
            <button type="submit" class="btn btn-danger">Delete</button>
        </form>
        <button class="submit-btn" style="margin-top:17px;padding: 9px 25px; background-color: white;border: 2px solid black;border-radius:5px" onclick="openeditEventModal()">Edit</button>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
    document.getElementById('loadingOverlay').style.display = 'none';
});
    const eventId = {{ event.id }};
    const tasks = {
        {% for task in tasks %}
        "{{ task.id }}": {
            "item": "{{ task.item }}",
            "description": "{{ task.description }}",
            "priority": {{ task.priority }},
            "completed": {{ 'true' if task.completed else 'false' }}
        },
        {% endfor %}
    };
    const strictModeEnabled = {{ strict_mode | tojson }};
    // Initialize the progress bar
    function initializeProgressBar(card) {
      const checkboxes = card.querySelectorAll('input.custom-checkbox');
      const progressBarFill = card.querySelector(".progress-bar-fill");
  
      // Update the progress bar when checkboxes are toggled
      checkboxes.forEach((checkbox) => {
        checkbox.addEventListener("change", () => {
          updateProgressBar(card);
          saveTaskState(checkbox); // Save the checkbox state to the database
        });
      });
  
      // Initialize the progress bar
      updateProgressBar(card);
    }
  
    // Update the progress bar
    function updateProgressBar() {
    const checkboxes = document.querySelectorAll('input.custom-checkbox');
    const checked = document.querySelectorAll('input[type="checkbox"].custom-checkbox:checked');
    console.log("Total checkboxes:", checkboxes.length);
    console.log("Checked checkboxes:", checked.length);

    const progress = Math.round((checked.length / checkboxes.length) * 100);
    console.log("Progress:", progress);

    const progressBarFill = document.querySelector(".progress-bar-fill");
    progressBarFill.style.width = `${progress}%`;

    setTimeout(() => {
        progressBarFill.style.transition = "width 0.3s ease";
    }, 100);
}
  
    // Save the checkbox state to the database
    function saveTaskState(checkbox) { 
      const taskId = checkbox.value;
      const task = tasks[taskId]; // Retrieve the task object
      const taskItem = task ? task.item : null; // Get task.item  
      console.log("Task Item:", taskItem); // Use taskItem as needed
      const completed = checkbox.checked;
      
      if (completed && strictModeEnabled && taskItem != "none"){
        openverifyTaskModal(taskId); // Open the modal if strict mode is enabled
      }
      // Send an AJAX request to update the task status
      else{fetch(`/update_task/${taskId}`, {
          method: "POST",
          headers: {
              "Content-Type": "application/json",
          },
          body: JSON.stringify({ completed: completed }),
      })
          .then((response) => response.json())
          .then((data) => {
              if (!data.success) {
                  console.error("Failed to update task status:", data.error);
                  alert("Failed to update task status.");
              } else {
                  console.log("Task updated successfully:", data.message);
              }
          })
          .catch((error) => {
              console.error("Error:", error);
              alert("An error occurred while updating the task status.");
          });}
      
  }
  
    // Initialize checkbox listeners
    function initializeCheckboxListeners() {
      const checkboxes = document.querySelectorAll('input.custom-checkbox');
      checkboxes.forEach((checkbox) => {
          checkbox.addEventListener("change", () => {
              saveTaskState(checkbox); // Save the checkbox state to the database
              updateProgressBar(); // Update the progress bar dynamically
          });
      });
  }
  document.addEventListener("DOMContentLoaded", () => {
    initializeCheckboxListeners();
    updateProgressBar(); // Initialize the progress bar on page load
  });
  
    // Initialize inline editing for the event name
    function initializeEditableEventName(card, eventId) {
      const eventNameElement = card.querySelector(".event-name");
  
      // Add double-click event listener
      eventNameElement.addEventListener("dblclick", () => {
        const currentName = eventNameElement.textContent.trim();
        const input = document.createElement("input");
        input.type = "text";
        input.value = currentName;
        input.classList.add("editable-input");
  
        // Replace the event name with the input field
        eventNameElement.textContent = "";
        eventNameElement.appendChild(input);
        input.focus();
  
        // Save changes when the user presses Enter or clicks outside
        const saveChanges = () => {
          const newName = input.value.trim();
          if (newName && newName !== currentName) {
            // Send an AJAX request to update the event name
            fetch(`/update_event_name/${eventId}`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ name: newName }),
            })
              .then((response) => {
                if (response.ok) {
                  eventNameElement.textContent = newName; // Update the UI
                } else {
                  eventNameElement.textContent = currentName; // Revert on failure
                  console.error("Failed to update event name");
                }
              })
              .catch((error) => {
                eventNameElement.textContent = currentName; // Revert on error
                console.error("Error:", error);
              });
          } else {
            eventNameElement.textContent = currentName; // Revert if no changes
          }
        };
  
        // Save changes on blur or Enter key
        input.addEventListener("blur", saveChanges);
        input.addEventListener("keydown", (event) => {
          if (event.key === "Enter") {
            saveChanges();
          }
        });
      });
    }
  
    // Initialize inline editing for the event date
    function initializeEditableEventDate(card, eventId) {
      const eventDateElement = card.querySelector(".event-date");
  
      // Add double-click event listener
      eventDateElement.addEventListener("dblclick", () => {
        const currentDate = eventDateElement.textContent
          .trim()
          .replace("Date: ", "");
        const input = document.createElement("input");
        input.type = "date";
        input.value = currentDate;
        input.classList.add("editable-input");
  
        // Replace the event date with the input field
        eventDateElement.textContent = "Date: ";
        eventDateElement.appendChild(input);
        input.focus();
  
        // Save changes when the user presses Enter or clicks outside
        const saveChanges = () => {
          const newDate = input.value.trim();
          if (newDate && newDate !== currentDate) {
            // Send an AJAX request to update the event date
            fetch(`/update_event_date/${eventId}`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ date: newDate }),
            })
              .then((response) => {
                if (response.ok) {
                  eventDateElement.textContent = `Date: ${newDate}`; // Update the UI
                } else {
                  eventDateElement.textContent = `Date: ${currentDate}`; // Revert on failure
                  console.error("Failed to update event date");
                }
              })
              .catch((error) => {
                eventDateElement.textContent = `Date: ${currentDate}`; // Revert on error
                console.error("Error:", error);
              });
          } else {
            eventDateElement.textContent = `Date: ${currentDate}`; // Revert if no changes
          }
        };
  
        // Save changes on blur or Enter key
        input.addEventListener("blur", saveChanges);
        input.addEventListener("keydown", (event) => {
          if (event.key === "Enter") {
            saveChanges();
          }
        });
      });
    }
    function openEditTaskModal(taskId, description,note, priority, dueDate,item) {
    // Populate the modal with task details
    document.getElementById("editTaskId").value = taskId;
    document.getElementById("editTaskDescription").value = description;
    document.getElementById("editTaskNote").value = note; // Set the note
    document.getElementById("editTaskItem").value = item; // Set item description
    document.getElementById("editTaskPriority").value = priority;
    document.getElementById("editTaskDueDate").value = dueDate; // Set the due date

    // Show the modal
    $("#editTaskModal").modal("show");
    $('.modal-backdrop').remove(); // Remove the backdrop to prevent it from closing the modal
}
function submitEditTask() {
    const taskId = document.getElementById("editTaskId").value;
    const description = document.getElementById("editTaskDescription").value.trim();
    const note = document.getElementById("editTaskNote").value.trim(); // Get the note
    const item = document.getElementById("editTaskItem").value.trim(); // Get the item description
    const priority = document.getElementById("editTaskPriority").value;
    const dueDate = document.getElementById("editTaskDueDate").value; // Get the due date

    if (!description) {
        alert("Task description cannot be empty.");
        return;
    }

    // Send the updated task details to the server
    fetch(`/edit_task/${taskId}`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify({
            description: description,
            note: note,
            priority: priority,
            due_date: dueDate, // Include the due date
            item: item, // Include the item description
        }),
    })
        .then((response) => response.json())
        .then((data) => {
            if (data.success) {
                $("#editTaskModal").modal("hide"); // Close the modal
                location.reload(); // Reload the page to reflect changes
            } else {
                alert(data.error || "Failed to update task.");
            }
        })
        .catch((error) => {
            console.error("Error:", error);
            alert("An error occurred while updating the task.");
        });
}
    function closeModal() {
    // Hide the modal
        $("#assignUserModal").modal("hide");
        $("#addTaskModal").modal("hide");
        $("#assignUserToEventModal").modal("hide");
        $("#editTaskModal").modal("hide");
        $("#verifyTaskModal").modal("hide");

    }
    function openAddTaskModal() {
        $('#addTaskModal').modal('show');
        $('.modal-backdrop').remove();
    }

    function submitAddTask() {
    const description = document.getElementById('newTaskDescription').value.trim();
    const item = document.getElementById('newTaskItem').value.trim(); // Get the item 
    const priority = document.getElementById('newTaskPriority').value;
    const dueDate = document.getElementById('newTaskDueDate').value; // Get the due date
    const note = document.getElementById('newTaskNote').value.trim(); // Get the note

    if (!description) {
        alert("Task description cannot be empty.");
        return;
    }

    // Send the new task details to the server
    fetch(`/add_task`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            description: description,
            note: note, // Include the note
            item: item, // Include the item description
            priority: priority,
            due_date: dueDate, // Include the due date
            event_id: {{ event.id }},
        }),
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                $('#addTaskModal').modal('hide'); // Close the modal
                location.reload(); // Reload the page to reflect changes
            } else {
                alert(data.error || "Failed to add task.");
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert("An error occurred while adding the task.");
        });
    }
    function assignUserToTask(taskId) {
      const emailInput = document.getElementById(`assign-user-email-${taskId}`);
      const userEmail = emailInput.value.trim();
  
      if (!userEmail) {
          alert("Please enter a valid email address.");
          return;
      }
  
      // Send an AJAX request to assign the user to the task
      fetch(`/assign_user/${taskId}`, {
          method: "POST",
          headers: {
              "Content-Type": "application/json",
          },
          body: JSON.stringify({ email: userEmail }),
      })
          .then((response) => response.json())
          .then((data) => {
              if (data.success) {
                //   alert(data.message);
                    $("#assignUserModal").modal("hide"); // Close the modal
                  emailInput.value = ""; // Clear the input field
                  location.reload();
              } else {
                  alert(data.error || "Failed to assign user.");
              }
          })
          .catch((error) => {
              console.error("Error:", error);
              alert("An error occurred while assigning the user.");
          });
  }

  function openAssignUserModal(taskId) {
    // Set the task ID in the hidden input field
    document.getElementById("assignTaskId").value = taskId;

    // Clear the selected checkboxes
    const checkboxes = document.querySelectorAll("#assignUserCheckboxes input[type='checkbox']");
    checkboxes.forEach(checkbox => checkbox.checked = false);
    // Show the modal
    $("#assignUserModal").modal("show");
    $('.modal-backdrop').remove();
}

function submitAssignUser() {
    const taskId = document.getElementById("assignTaskId").value;
    const checkboxes = document.querySelectorAll("#assignUserCheckboxes input[type='checkbox']:checked");
    const selectedUserIds = Array.from(checkboxes).map(checkbox => checkbox.value);
    const selectedUserNames = Array.from(checkboxes).map(checkbox => checkbox.nextElementSibling.textContent);

    if (selectedUserIds.length === 0) {
        alert("Please select at least one user.");
        return;
    }

    // Debug: Log selected user IDs and names
    console.log("Selected User IDs:", selectedUserIds);
    console.log("Selected User Names:", selectedUserNames);

    // Send an AJAX request to assign the selected users to the task
    fetch(`/assign_users_to_task/${taskId}`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify({ user_ids: selectedUserIds }),
    })
        .then((response) => response.json())
        .then((data) => {
            if (data.success) {
                // alert(data.message);
                $("#assignUserModal").modal("hide"); // Close the modal
                location.reload(); // Reload the page to reflect changes
            } else {
                alert(data.error || "Failed to assign users to the task.");
            }
        })
        .catch((error) => {
            console.error("Error:", error);
            alert("An error occurred while assigning users to the task.");
        });
}


function openAssignUserToEventModal() {
    // Clear the selected checkboxes
    const checkboxes = document.querySelectorAll("#assignFriendCheckboxes input[type='checkbox']");

    // Show the modal
    $("#assignUserToEventModal").modal("show");
    $('.modal-backdrop').remove(); // Remove the backdrop
}

function submitAssignFriendsToEvent() {
    const checkboxes = document.querySelectorAll("#assignFriendCheckboxes input[type='checkbox']");
    const selectedFriendIds = Array.from(checkboxes)
        .filter(checkbox => checkbox.checked)
        .map(checkbox => checkbox.value);
    const unselectedFriendIds = Array.from(checkboxes)
        .filter(checkbox => !checkbox.checked)
        .map(checkbox => checkbox.value);

    // Send an AJAX request to update the assigned friends
    fetch(`/update_event_participants/${eventId}`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify({ add: selectedFriendIds, remove: unselectedFriendIds }),
    })
        .then((response) => response.json())
        .then((data) => {
            if (data.success) {
                alert(data.message);
                $("#assignUserToEventModal").modal("hide"); // Close the modal
                location.reload(); // Reload the page to reflect changes
            } else {
                alert(data.error || "Failed to update event participants.");
            }
        })
        .catch((error) => {
            console.error("Error:", error);
            alert("An error occurred while updating event participants.");
        });
}
function enableEditTask(taskId) {
    const taskText = document.getElementById(`task-text-${taskId}`);
    const taskInput = document.getElementById(`task-input-${taskId}`);
    const taskPriority = document.getElementById(`task-priority-${taskId}`);
    const editButton = document.querySelector(`.edit-task-btn[onclick="enableEditTask(${taskId})"]`);

    // Hide the task text and show the input and dropdown
    taskText.style.display = 'none';
    taskInput.style.display = 'inline-block';
    taskPriority.style.display = 'inline-block';
    editButton.style.display = 'none'; // Hide the edit button

    // Focus on the input field
    taskInput.focus();

    // Save changes when the user presses Enter
    taskInput.addEventListener('keypress', function (event) {
        if (event.key === 'Enter') {
            saveTaskChanges(taskId);
        }
    });

    // Save changes when the priority dropdown changes
    taskPriority.addEventListener('change', function () {
        saveTaskChanges(taskId);
    });

    // Save changes when the input loses focus
    taskInput.addEventListener('blur', function () {
        saveTaskChanges(taskId);
    });
}

function saveTaskChanges(taskId) {
    const taskText = document.getElementById(`task-text-${taskId}`);
    const taskInput = document.getElementById(`task-input-${taskId}`);
    const taskPriority = document.getElementById(`task-priority-${taskId}`);
    const editButton = document.querySelector(`.edit-task-btn[onclick="enableEditTask(${taskId})"]`);

    const newDescription = taskInput.value.trim();
    const newPriority = taskPriority.value;

    if (!newDescription) {
        alert("Task description cannot be empty.");
        return;
    }

    // Send the updated task details to the server
    fetch(`/edit_task/${taskId}`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify({
            description: newDescription,
            priority: newPriority,
        }),
    })
        .then((response) => response.json())
        .then((data) => {
            if (data.success) {
                // Update the UI
                taskText.textContent = newDescription;
                taskText.style.display = 'inline-block';
                taskInput.style.display = 'none';
                taskPriority.style.display = 'none';
                editButton.style.display = 'inline-block';

                // Optionally update the color based on priority
                if (newPriority === "1") {
                    taskText.style.color = "rgb(18, 141, 218)";
                } else if (newPriority === "2") {
                    taskText.style.color = "rgb(131, 185, 194)";
                } else {
                    taskText.style.color = white;
                }
            } else {
                alert(data.error || "Failed to update task.");
            }
        })
        .catch((error) => {
            console.error("Error:", error);
            alert("An error occurred while updating the task.");
        });
}
document.addEventListener("DOMContentLoaded", () => {
    // Restore the scroll position after the page reloads
    const savedScrollPosition = localStorage.getItem("scrollPosition");
    if (savedScrollPosition) {
        window.scrollTo(0, parseInt(savedScrollPosition, 10));
        localStorage.removeItem("scrollPosition"); // Clear the saved position after restoring
    }

    // Attach the event listener to all modals
    const modals = document.querySelectorAll(".modal");
    modals.forEach((modal) => {
        $(modal).on("hidden.bs.modal", () => {
            console.log("Modal closed. Reloading the page...");

            // Save the current scroll position before reloading
            localStorage.setItem("scrollPosition", window.scrollY);

            location.reload(); // Reload the page when the modal is closed
        });
    });
});
    document.addEventListener("DOMContentLoaded", () => {
        const savedTheme = localStorage.getItem("theme");
        if (savedTheme === "light") {
            document.body.classList.add("light-mode");
        }
    });

    // Open the modal and set the task ID
    function openverifyTaskModal(taskId) {
        document.getElementById('taskId').value = taskId;
        $('#verifyTaskModal').modal('show');
        $('.modal-backdrop').remove(); // Remove the backdrop to prevent it from closing the modal
    }

    // Handle form submission
    document.getElementById('verifyTaskForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const formData = new FormData(this);
        const taskId = document.getElementById('taskId').value;
        document.getElementById('loadingOverlay').style.display = 'flex';

        fetch(`/complete_task_with_image/${taskId}`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {

                alert(data.message);
                location.reload(); // Reload the page to reflect changes
            } else {
                alert(data.message);
                location.reload(); // Reload the page to reflect changes
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while completing the task.');
        });
    });
    document.addEventListener("DOMContentLoaded", () => {
        const strictModeEnabled = localStorage.getItem("strictMode") === "true";
        document.getElementById("strictModeToggle").checked = strictModeEnabled;

        // Apply strict mode if enabled
        if (strictModeEnabled) {
            enableStrictMode();
        } else {
            disableStrictMode();
        }
    });

    // Toggle Strict Mode
    function toggleStrictMode() {
        const strictModeEnabled = document.getElementById("strictModeToggle").checked;

        // Send an AJAX request to update the strict mode status on the server
        fetch(`/strict_mode/${eventId}`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({ strict_mode: strictModeEnabled }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log(data.message);
                if (strictModeEnabled) {
                    enableStrictMode();
                    location.reload(); // Reload the page to reflect changes
                } else {
                    disableStrictMode();
                    location.reload(); // Reload the page to reflect changes
                }
                localStorage.setItem("strictMode", strictModeEnabled);
                
            } else {
                alert(data.error || "Failed to update strict mode.");
                // Revert the toggle state if the update fails
                document.getElementById("strictModeToggle").checked = !strictModeEnabled;
            }
        })
        .catch(error => {
            console.error("Error:", error);
            alert("An error occurred while updating strict mode.");
            // Revert the toggle state if an error occurs
            document.getElementById("strictModeToggle").checked = !strictModeEnabled;
        });

        // Save the state in localStorage
        localStorage.setItem("strictMode", strictModeEnabled);
    }

    // Enable Strict Mode
    function enableStrictMode() {
        console.log("Strict Mode Enabled");
        document.body.classList.add("strict-mode");
        
    }

    // Disable Strict Mode
    function disableStrictMode() {
        console.log("Strict Mode Disabled");
        document.body.classList.remove("strict-mode");
    }
    function bypassItem() {
    const taskId = document.getElementById('taskId').value;

    fetch(`/bypass_item/${taskId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ bypass: true }) // Optional: Include additional data if needed
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload(); // Reload the page to reflect changes
        } else {
            alert(data.error || "Failed to bypass the item.");
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while bypassing the item.');
    });
}
function openeditEventModal() {
    // Show the modal
    $("#editEventModal").modal("show");
    $('.modal-backdrop').remove(); // Remove the backdrop
}

function submitEditEvent() {
    const newOwnerId = document.getElementById("newOwnerSelect").value;
    const newEventName = document.getElementById("eventName").value.trim();
    const newEventDate = document.getElementById("eventDate").value.trim();

    if (!newOwnerId) {
        alert("Please select a new owner.");
        return;
    }

    // Send an AJAX request to update the event owner
    fetch(`/edit_event/${eventId}`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify({ new_owner_id: newOwnerId,
            new_event_name: newEventName,
            new_event_date: newEventDate, // Include the new event date if needed
         }),
    })
        .then((response) => response.json())
        .then((data) => {
            if (data.success) {
                $("#editEventModal").modal("hide"); // Close the modal
                location.reload(); // Reload the page to reflect changes
            } else {
                alert(data.error || "Failed to change event ownership.");
            }
        })
        .catch((error) => {
            console.error("Error:", error);
            alert("An error occurred while changing event ownership.");
        });
}
function openVerifyCompletedTaskModal(taskId,note, imageLink, description) {
    // Set the task ID in a hidden field or variable
    window.currentTaskId = taskId;
    
    // Set the image source and description
    const taskImagePreview = document.getElementById("taskImagePreview");
    const taskDescription = document.getElementById("taskDescription");
    const taskNote = document.getElementById("TaskNote");

    if (imageLink) {
        taskImagePreview.src = `/static/${imageLink}`;
        taskImagePreview.style.display = "block";
    } else {
        taskImagePreview.src = "";
        taskImagePreview.style.display = "none";
    }

    taskDescription.textContent = description;
    taskNote.textContent = note; // Set the note
    // Show the modal
    $("#verifyCompletedTaskModal").modal("show");
    $('.modal-backdrop').remove(); // Remove the backdrop
}

function verifyTask(isVerified) {
    const taskId = window.currentTaskId;
    const note = document.getElementById("TaskNote").value.trim(); // Get the note from the modal

    // Send an AJAX request to verify or reject the task
    fetch(`/verify_task/${taskId}`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify({ 
            verified: isVerified, 
            note: note // Include the note in the request body
        }),
    })
        .then((response) => response.json())
        .then((data) => {
            if (data.success) {
                alert(data.message);
                $("#verifyCompletedTaskModal").modal("hide"); // Close the modal
                location.reload(); // Reload the page to reflect changes
            } else {
                alert(data.error || "Failed to verify the task.");
            }
        })
        .catch((error) => {
            console.error("Error:", error);
            alert("An error occurred while verifying the task.");
        });
}
</script>


{% endblock %}
