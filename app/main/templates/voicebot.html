{% extends "base.html" %}

{% block content %}
<head>
    <title>Event Planner Voice Assistant</title>
    <style>

        body {
            font-family: Arial, sans-serif;
            display: flex;
            margin: 0;
            
        }
        #voice-indicator-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            height: calc(100vh - 60px); /* Adjust height to account for the navbar height */
        }
        #voice-indicator {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background-color: #4fa4ff;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 18px;
            text-align: center;
            cursor: pointer;
            animation: pulse-listening 1.5s infinite;
        }

        #voice-indicator.speaking {
            background-color: #474747;
            animation: pulse-speaking 1.5s infinite;
        }

        @keyframes pulse-listening {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.7);
            }
            70% {
                transform: scale(1.2);
                box-shadow: 0 0 0 20px rgba(0, 123, 255, 0);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(0, 123, 255, 0);
            }
        }

        @keyframes pulse-speaking {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
            }
            70% {
                transform: scale(1.2);
                box-shadow: 0 0 0 20px rgba(40, 167, 69, 0);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
            }
        }
    </style>
</head>
<body>
    <div id="status" style="display: none;"></div> <!-- Add this element -->
    <div id="voice-indicator-wrapper">
        <div id="voice-indicator">Start</div>
    </div>
    


<script>
    const voiceIndicator = document.getElementById('voice-indicator');
    const isAuthenticated = {{ current_user.is_authenticated | tojson }};
    const user_language = {{ current_user.language | tojson }};
    let eventId = null;
    let eventCreationMode = isAuthenticated; // Only enable event creation mode if the user is authenticated
    let conversationHistory = [];
    let questionIndex = 0;

    function speakMessage(message) {
    voiceIndicator.textContent = "Speaking";
    voiceIndicator.classList.add('speaking'); // Change to speaking mode
    const targetLang = user_language.split('-')[0]; // Extract language code (e.g., "en" from "en-US")

    // Translate the message to the target language
    fetch('/translate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text: message, target_lang: targetLang })
    })
    .then(response => response.json())
    .then(data => {
        const translated = data.translated_text || message; // Use translated text or fallback to the original
        console.log(`DEBUG: Speaking message: "${translated}"`); // Debugging: Log the message being spoken

        // Send the translated message to the /speak endpoint to generate audio
        fetch('/speak', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: translated, lang: user_language })
        })
        .then(response => response.blob())
        .then(blob => {
            const audioURL = URL.createObjectURL(blob);
            const audio = new Audio(audioURL);

            // Play the audio and handle the end of speech
            audio.onended = function() {
                voiceIndicator.textContent = "Listening";
                voiceIndicator.classList.remove('speaking'); // Revert to listening mode
                startDictation(); // Restart dictation after speaking
            };
            audio.play();
        })
        .catch(error => {
            console.error("Error generating speech audio:", error);
            voiceIndicator.textContent = "Listening";
            voiceIndicator.classList.remove('speaking'); // Revert to listening mode
            startDictation(); // Restart dictation even if audio fails
        });
    })
    .catch(error => {
        console.error("Translation failed:", error);
        voiceIndicator.textContent = "Listening";
        voiceIndicator.classList.remove('speaking'); // Revert to listening mode
        startDictation(); // Restart dictation even if translation fails
    });
}

    function startDictation() {
        if ('webkitSpeechRecognition' in window) {
            const recognition = new webkitSpeechRecognition();
            recognition.lang = user_language;
            recognition.continuous = false;
            recognition.interimResults = false;

            recognition.onstart = function() {
                document.getElementById('status').textContent = "Listening...";
                voiceIndicator.textContent = "Listening";
                voiceIndicator.classList.remove('speaking');
            };

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                console.log(`DEBUG: You said: "${transcript}"`); // Debugging: Log the transcribed speech
                document.getElementById('status').textContent = `You said: "${transcript}"`;
                processMessage(transcript); // Process the transcribed message
            };

            recognition.onerror = function(event) {
                console.error("Speech recognition error:", event.error);
                document.getElementById('status').textContent = "Sorry, I couldn't understand. Please try again.";
                speakMessage("Sorry, I couldn't understand. Please try again.");
            };

            recognition.onend = function() {
                document.getElementById('status').textContent = "Waiting for response...";
                voiceIndicator.textContent = "Waiting...";
            };

            recognition.start();
        } else {
            alert("Speech recognition is not supported in this browser.");
        }
    }

    function processMessage(message) {
        console.log(`DEBUG: Processing message: "${message}"`); // Debugging: Log the message being processed
        if (isAuthenticated) {
            if (eventCreationMode) {
                if (eventId === null) {
                    fetch('/create_event', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ eventName: message }),
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.eventId) {
                            eventId = data.eventId;
                            const botMessage = `Please provide more details about the event.`;
                            document.getElementById('status').textContent = botMessage;
                            speakMessage(botMessage);
                        } else if (data.error) {
                            const errorMessage = `Error: ${data.error}`;
                            document.getElementById('status').textContent = errorMessage;
                            speakMessage(errorMessage);
                            eventCreationMode = false;
                        }
                    });
                } else {
                    let requestBody = { event_id: eventId, userInput: message, question_index: questionIndex };

                    if (conversationHistory.length > 0) {
                        requestBody.conversation_history = conversationHistory;
                    }

                    fetch('/create_event_and_tasks', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(requestBody),
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.message) {
                            const botMessage = data.message;
                            document.getElementById('status').textContent = botMessage;
                            speakMessage(botMessage);
                            eventCreationMode = false;
                            conversationHistory = [];
                            questionIndex = 0;
                            window.location.href = `/checklist_detail/${eventId}`;
                        } else if (data.question) {
                            const botQuestion = data.question;
                            document.getElementById('status').textContent = botQuestion;
                            speakMessage(botQuestion);
                            conversationHistory.push(`User: ${message}`);
                            conversationHistory.push(`Bot: ${botQuestion}`);
                            questionIndex = data.question_index;
                        } else if (data.error) {
                            const errorMessage = `Error: ${data.error}`;
                            document.getElementById('status').textContent = errorMessage;
                            speakMessage(errorMessage);
                            eventCreationMode = false;
                            conversationHistory = [];
                            questionIndex = 0;
                        }
                    });
                }
            } else {
                fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: message, event_id: eventId }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.response) {
                        const botResponse = data.response;
                        document.getElementById('status').textContent = botResponse;
                        speakMessage(botResponse);
                    } else if (data.error) {
                        const errorMessage = `Error: ${data.error}`;
                        document.getElementById('status').textContent = errorMessage;
                        speakMessage(errorMessage);
                    }
                })
                .catch(error => {
                    const networkError = `Network error: ${error}`;
                    document.getElementById('status').textContent = networkError;
                    speakMessage(networkError);
                });
            }
        } else {
            fetch('/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: message }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.response) {
                    const botResponse = data.response;
                    document.getElementById('status').textContent = botResponse;
                    speakMessage(botResponse);
                } else if (data.error) {
                    const errorMessage = `Error: ${data.error}`;
                    document.getElementById('status').textContent = errorMessage;
                    speakMessage(errorMessage);
                }
            })
            .catch(error => {
                const networkError = `Network error: ${error}`;
                document.getElementById('status').textContent = networkError;
                speakMessage(networkError);
            });
        }
    }
    document.getElementById("voice-indicator").addEventListener("click", function() {
        let initialMessage = 'Hi,What is your new event name?';
       
       if (!isAuthenticated) {
           initialMessage = 'Hi, I am a bot that can help you with event planning. Please provide details about your event.';
           eventCreationMode = false; // Disable event creation mode for unauthenticated users
       }
       document.getElementById('status').textContent = initialMessage;
       speakMessage(initialMessage);
    // You can replace this with any action you want
    });
    window.onload = function() {
        document.getElementById("voice-indicator").style.backgroundColor = "#4fa4ff"; // Set initial color
    };
    </script>
</body>
{% endblock %}
</html>