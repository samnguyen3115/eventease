{% extends "base.html" %}
{% block content %}
<!-- Add Friend Modal -->
<div class="modal fade" id="addFriendModal" tabindex="-1" role="dialog" aria-labelledby="addFriendModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addFriendModalLabel">Add a Friend</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="addFriendForm">
                    <div class="form-group">
                        <label for="friendEmail">Friend's Email</label>
                        <input type="email" class="form-control" id="friendEmail" placeholder="Enter friend's email" required>
                    </div>
                    <div id="addFriendMessage" class="text-success"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="submit" class="btn btn-primary" form="addFriendForm">Add Friend</button>
            </div>
        </div>
    </div>
</div>
<div class="container mt-4">
    <h2 class="text-center">Profile</h2>
    <div class="card mx-auto" style="max-width: 60%; background-color: #f9fbfc;">
        <div class="card-body text-center">
            <!-- Display Profile Picture -->
            <img src="{{ url_for('static', filename=current_user.profile_picture or 'img/user.png') }}" 
                 alt="Profile Picture" 
                 class="rounded-circle mb-3" 
                 style="width: 150px; height: 150px; object-fit: cover;">

            <h5 style="font-size: x-large; color: rgb(0, 0, 0);">{{ user.username }}</h5>
            <p style="color: rgb(0, 0, 0);"><strong>Email:</strong> {{ user.email }}</p>
            
            <!-- Profile Action Buttons -->
            <div class="mb-3">
                <a href="{{ url_for('main.edit_profile') }}" class="btn" style="background-color:white; border: 2px solid rgb(3, 82, 255);">Edit Profile</a>
                <a href="{{ url_for('auth.change_password') }}" class="btn" style="background-color:white; border: 2px solid rgb(255, 165, 0);">Change Password</a>
                <a href="{{ url_for('main.calendar_feed') }}" class="btn" style="background-color:white; border: 2px solid black;">Download Calendar Feed</a>
                <a href="{{ url_for('auth.logout') }}" class="btn" style="background-color:white; border: 2px solid red;">Logout</a>
            </div>

            <!-- Friends Dropdown -->
            <div class="dropdown mt-3">
                <button class="btn btn-secondary dropdown-toggle" type="button" id="friendsDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Friends
                </button>
                <div class="dropdown-menu" aria-labelledby="friendsDropdown" id="friendsList">
                    <!-- Add Friend Button -->
                    <button class="dropdown-item text-primary" data-toggle="modal" data-target="#addFriendModal" style = "color:black">+ Add Friend</button>
                    <div class="dropdown-divider"></div>
                    <!-- Friends will be dynamically loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Include Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Include jQuery and Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
    loadFriends();

    // Add Friend Form Submission
    document.getElementById("addFriendForm").addEventListener("submit", function (e) {
        e.preventDefault();
        const email = document.getElementById("friendEmail").value;

        fetch("/add_friend", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email }),
        })
            .then((response) => response.json())
            .then((data) => {
                const messageDiv = document.getElementById("addFriendMessage");
                if (data.success) {
                    messageDiv.textContent = data.message;
                    messageDiv.classList.add("text-success");
                    messageDiv.classList.remove("text-danger");
                    document.getElementById("friendEmail").value = ""; // Clear the input field
                    setTimeout(() => {
                        $("#addFriendModal").modal("hide"); // Close the modal
                        loadFriends(); // Reload the friends list
                    }, 2000);
                } else {
                    messageDiv.textContent = data.error;
                    messageDiv.classList.add("text-danger");
                    messageDiv.classList.remove("text-success");
                }
            })
            .catch((error) => {
                console.error("Error:", error);
                const messageDiv = document.getElementById("addFriendMessage");
                messageDiv.textContent = "An error occurred. Please try again.";
                messageDiv.classList.add("text-danger");
                messageDiv.classList.remove("text-success");
            });
    });
});

function loadFriends() {
    fetch("/friends")
        .then((response) => response.json())
        .then((data) => {
            const friendsList = document.getElementById("friendsList");
            friendsList.innerHTML = `
                <button class="dropdown-item text-primary" style = "color:black" data-toggle="modal" data-target="#addFriendModal">+ Add Friend</button>
                <div class="dropdown-divider"></div>
            `;

            data.friends.forEach((friend) => {
                const friendItem = document.createElement("div");
                friendItem.className = "dropdown-item d-flex justify-content-between align-items-center";
                friendItem.innerHTML = `
                    <span>${friend.username}</span>
                    <button class="task-btn" id = "delete-btn"  style = "margin-left:20px" onclick="deleteFriend(${friend.id})"><img class=" img-btn" id ="delete-img" src="{{ url_for('static', filename='img/delete.png') }}" alt="Delete" style="width: 20px; height: 20px;"></button>
                `;
                friendsList.appendChild(friendItem);
            });
        })
        .catch((error) => console.error("Error loading friends:", error));
}

function deleteFriend(friendId) {
    if (confirm("Are you sure you want to delete this friend?")) {
        fetch(`/remove_friend/${friendId}`, { method: "POST" })
            .then((response) => response.json())
            .then((data) => {
                if (data.success) {
                    alert(data.message);
                    loadFriends(); // Reload the friends list
                } else {
                    alert(data.error);
                }
            })
            .catch((error) => console.error("Error deleting friend:", error));
    }
}
    // // Function to copy the calendar link to clipboard
    // function copyCalendarFeed() {
    //     // Get the URL of the calendar feed
    //     const calendarURL = window.location.origin + '/calendar.ics'; // Corrected the URL path
        
    //     // Create a temporary textarea to copy the URL
    //     const textarea = document.createElement('textarea');
    //     textarea.value = calendarURL; // Set the value to the ICS feed URL
    //     document.body.appendChild(textarea); // Append the textarea to the body
    //     textarea.select(); // Select the text (URL)
    //     document.execCommand('copy'); // Copy the URL to the clipboard
    //     document.body.removeChild(textarea); // Remove the textarea

    //     // Notify the user
    //     alert('Calendar feed subscription link copied to clipboard! You can now paste it into another calendar app.');
    // }
</script>
{% endblock %}